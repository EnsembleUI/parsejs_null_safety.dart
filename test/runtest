set -e

BASEDIR=$(dirname $0)

if (($# == 0)); then
	rm -f tmp/*
	FILES=$(find testcases | grep '.js')
	BASEDIR='testcases'
elif [[ -d $1 ]]; then
	FILES=$(find $1 | grep '.js')
	BASEDIR="$1"
else
	FILES=$*
	if (($# == 1)); then
		SINGLE=true
	fi
fi

for file in $FILES
do
	path=$(python -c "import os.path; print os.path.relpath('$file', '$BASEDIR')")
	name=$(basename $file)
	name=${name%.js}
	printf "%-50s" $path

	if dart tojson.dart $file > tmp/mine.json 2> tmp/$name.err; then
		rm -f tmp/$name.err
	else
		echo "[EXCEPTION]"
		cat $file >> tmp/$name.err
		if [ $SINGLE ]; then
			cat tmp/$name.err
		fi
		continue
	fi

	if node esprima/tojson.js $file > tmp/correct.json 2> tmp/$name.esprima.err; then
		rm -f tmp/$name.esprima.err
	else
		cat $file >> tmp/$name.esprima.err
		rm $file
		echo "[OK] [ESPRIMA EXCEPTION] [DELETED!]"
		continue
	fi

	json -f tmp/mine.json > tmp/mine1.json
	json -f tmp/correct.json > tmp/correct1.json

	if diff tmp/mine1.json tmp/correct1.json > tmp/$name.err;
	then
		rm -f tmp/$name.err
		echo "[OK]"
	else
		echo "[WRONG OUTPUT]"
		cat $file >> tmp/$name.err
		if [ $SINGLE ]; then
			cat tmp/$name.diff
		fi
	fi
done
